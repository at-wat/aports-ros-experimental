pkgname=ros-melodic-imu-filter-madgwick
_pkgname=imu_filter_madgwick
pkgver=1.2.1
pkgrel=0
pkgdesc="$_pkgname package for ROS melodic"
url="http://ros.org/wiki/imu_filter_madgwick"
arch="all"
license="GPL"
depends="ros-melodic-dynamic-reconfigure ros-melodic-geometry-msgs ros-melodic-message-filters ros-melodic-nodelet ros-melodic-pluginlib ros-melodic-roscpp ros-melodic-sensor-msgs ros-melodic-tf2 ros-melodic-tf2-geometry-msgs ros-melodic-tf2-ros ros-melodic-dynamic-reconfigure ros-melodic-geometry-msgs ros-melodic-message-filters ros-melodic-nodelet ros-melodic-pluginlib ros-melodic-roscpp ros-melodic-sensor-msgs ros-melodic-tf2 ros-melodic-tf2-geometry-msgs ros-melodic-tf2-ros"
makedepends="py-setuptools py-rosdep py-rosinstall py-rosinstall-generator py-wstool chrpath ros-melodic-catkin ros-melodic-dynamic-reconfigure ros-melodic-geometry-msgs ros-melodic-message-filters ros-melodic-nodelet ros-melodic-pluginlib ros-melodic-roscpp ros-melodic-rosunit ros-melodic-sensor-msgs ros-melodic-tf2 ros-melodic-tf2-geometry-msgs ros-melodic-tf2-ros"
subpackages="$pkgname-dbg"
source=""
builddir="$startdir/apk-build-temporary"
srcdir="/tmp/dummy-src-dir"
buildlog="$builddir/ros-abuild-build.log"
checklog="$builddir/ros-abuild-check.log"
statuslog="$builddir/ros-abuild-status.log"
if [ x${GENERATE_BUILD_LOGS} != "xyes" ]; then
  buildlog="/dev/null"
  checklog="/dev/null"
  statuslog="/dev/null"
fi
rosinstall="- git: {local-name: imu_filter_madgwick, uri: 'https://github.com/uos-gbp/imu_tools-release.git',
    version: release/melodic/imu_filter_madgwick/1.2.1-1}
"
prepare() {
  set -o pipefail
  mkdir -p $builddir
  echo "preparing" > $statuslog
  cd "$builddir"
  rm -rf src || true
  mkdir -p src
  echo "$rosinstall" > pkg.rosinstall
  wstool init --shallow src pkg.rosinstall
  find $startdir -maxdepth 1 -name "*.patch" | while read patchfile; do
    echo "Applying $patchfile"
    (cd src/* && patch -p1 -i $patchfile)
  done
}
build() {
  set -o pipefail
  echo "building" > $statuslog
  cd "$builddir"
  source /usr/ros/melodic/setup.sh
  catkin_make_isolated \
    -DCMAKE_BUILD_TYPE=RelWithDebInfo 2>&1 | tee $buildlog
}
check() {
  if [ -f $startdir/NOCHECK ]; then
    echo "Check skipped" | tee $checklog
    return 0
  fi
  set -o pipefail
  echo "checking" >> $statuslog
  cd "$builddir"
  source /usr/ros/melodic/setup.sh
  source devel_isolated/setup.sh
  catkin_make_isolated -DCMAKE_BUILD_TYPE=RelWithDebInfo \
    --catkin-make-args run_tests 2>&1 | tee $checklog
  catkin_test_results 2>&1 | tee $checklog
}
dbg() {
  mkdir -p "$subpkgdir"
  default_dbg
}
package() {
  echo "packaging" >> $statuslog
  mkdir -p "$pkgdir"
  cd "$builddir"
  export DESTDIR="$pkgdir"
  source /usr/ros/melodic/setup.sh
  catkin_make_isolated -DCMAKE_BUILD_TYPE=RelWithDebInfo --install-space /usr/ros/melodic
  catkin_make_isolated -DCMAKE_BUILD_TYPE=RelWithDebInfo --install --install-space /usr/ros/melodic
  rm -f "$pkgdir"/usr/ros/melodic/setup.* "$pkgdir"/usr/ros/melodic/local_setup.* "$pkgdir"/usr/ros/melodic/.rosinstall "$pkgdir"/usr/ros/melodic/_setup_util.py "$pkgdir"/usr/ros/melodic/env.sh "$pkgdir"/usr/ros/melodic/.catkin
  find $pkgdir -name "*.so" | while read so; do
    chrpath_out=$(chrpath ${so} || true)
    if echo ${chrpath_out} | grep -q "RPATH="; then
      rpath=$(echo -n "${chrpath_out}" | sed -e "s/^.*RPATH=//")
      if echo "${rpath}" | grep -q home; then
        echo "RPATH contains home!: ${rpath}"
        rpathfix=$(echo -n "${rpath}" | tr ":" "\n" \
          | grep -v -e home | tr "\n" ":" | sed -e "s/:$//; s/::/:/;")
        echo "Fixing to ${rpathfix}"
        chrpath -r ${rpathfix} ${so} || (echo chrpath failed; false)
      fi
    fi
  done
  echo "finished" >> $statuslog
}