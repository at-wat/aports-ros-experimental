pkgname=ros-noetic-python-orocos-kdl
_pkgname=python_orocos_kdl
pkgver=1.4.0_git20200418
pkgrel=0
pkgdesc="$_pkgname package for ROS noetic"
url="http://wiki.ros.org/python_orocos_kdl"
arch="all"
license="LGPL"

depends="py-sip py-sip-dev ros-noetic-catkin ros-noetic-orocos-kdl py-sip py-sip-dev ros-noetic-catkin ros-noetic-orocos-kdl"
makedepends="py-setuptools py-rosdep py-rosinstall py-rosinstall-generator py-wstool chrpath cmake py-sip py-sip-dev py3-psutil ros-noetic-orocos-kdl"

subpackages="$pkgname-dbg"

source=""
builddir="$startdir/abuild"
srcdir="/tmp/dummy-src-dir"
buildlog="$builddir/ros-abuild-build.log"
checklog="$builddir/ros-abuild-check.log"
statuslog="$builddir/ros-abuild-status.log"
if [ x${GENERATE_BUILD_LOGS} != "xyes" ]; then
  buildlog="/dev/null"
  checklog="/dev/null"
  statuslog="/dev/null"
fi

export ROS_PYTHON_VERSION=3
rosinstall="- git:
    local-name: python_orocos_kdl
    uri: https://github.com/MatthijsBurgh/orocos_kinematics_dynamics.git
    version: pybind11
"

prepare() {
  set -o pipefail
  mkdir -p $builddir
  echo "preparing" > $statuslog
  cd "$builddir"
  rm -rf src || true
  mkdir -p src
  echo "$rosinstall" > pkg.rosinstall
  wstool init --shallow src pkg.rosinstall
  find src -name package.xml | while read manifest; do
    dir=$(dirname $manifest)
    pkg=$(sed $manifest \
          -e ':l1;N;$!b l1;s/.*<\s*name\s*>\s*\(.*\)\s*<\s*\/name\s*>.*/\1/;')
    if [ $pkg != $_pkgname ]; then
      echo Ignoring $pkg which is not $_pkgname
      touch $dir/CATKIN_IGNORE
    fi
  done
  find $startdir -maxdepth 1 -name "*.patch" | while read patchfile; do
    echo "Applying $patchfile"
    (cd src/* && patch -p1 -i $patchfile)
  done
  mv src/python_orocos_kdl/python_orocos_kdl/* src/python_orocos_kdl/
  sed 's|find_package(catkin QUIET)|# \1|' -i src/python_orocos_kdl/CMakeLists.txt
}

build() {
  set -o pipefail
  echo "building" > $statuslog
  cd "$builddir"
  mkdir src/$_pkgname/build
  cd src/$_pkgname/build
  cmake .. \
    -DCMAKE_INSTALL_PREFIX=/usr/ros/noetic \
    -DCMAKE_BUILD_TYPE=RelWithDebInfo \
    -DCMAKE_INSTALL_LIBDIR=lib 2>&1 | tee $buildlog
  make 2>&1 | tee -a $buildlog
}

check() {
  if [ -f $startdir/NOCHECK ]; then
    echo "Check skipped" | tee $checklog
    return 0
  fi
  set -o pipefail
  echo "checking" >> $statuslog
  cd "$builddir"
  cd src/$_pkgname/build
  if [ $(make -q test > /dev/null 2> /dev/null; echo $?) -eq 1 ]; then
    make test 2>&1 | tee $checklog
  fi
}

dbg() {
  mkdir -p "$subpkgdir"
  default_dbg
}

package() {
  echo "packaging" >> $statuslog
  mkdir -p "$pkgdir"
  cd "$builddir"
  export DESTDIR="$pkgdir"

  cd src/$_pkgname/build
  make install

  # Tweak invalid RPATH
  find $pkgdir -name "*.so" | while read so; do
    chrpath_out=$(chrpath ${so} || true)
    if echo ${chrpath_out} | grep -q "RPATH="; then
      rpath=$(echo -n "${chrpath_out}" | sed -e "s/^.*RPATH=//")
      if echo "${rpath}" | grep -q home; then
        echo "RPATH contains home!: ${rpath}"
        rpathfix=$(echo -n "${rpath}" | tr ":" "\n" \
          | grep -v -e home | tr "\n" ":" | sed -e "s/:$//; s/::/:/;")
        echo "Fixing to ${rpathfix}"
        chrpath -r ${rpathfix} ${so} || (echo chrpath failed; false)
      fi
    fi
  done

  # Tweak hardcoded library versions
  find $pkgdir -name "*.cmake" | while read cm; do
    libs=$(sed -n '/^set(libraries/{s/^.*"\(.*\)")$/\1/;s/;/ /g;p}' $cm)
    for lib in $libs; do
      rep=
      # lib.so.0.1.2 -> lib.so.0.1
      if echo $lib | grep -q -e '\.so\.[0-9]\{1,\}\.[0-9]\{1,\}\.[0-9]\{1,\}$'; then
        rep=$(echo $lib | sed -e 's/\(\.so\.[0-9]\{1,\}\.[0-9]\{1,\}\)\.[0-9]\{1,\}$/\1/')
      fi
      # lib-0.1.so.2 -> lib-0.1.so
      if echo $lib | grep -q -e '-[0-9]\{1,\}\.[0-9]\{1,\}\.so\.[0-9]\{1,\}$'; then
        rep=$(echo $lib | sed -e 's/\(-[0-9]\{1,\}\.[0-9]\{1,\}\.so\)\.[0-9]\{1,\}$/\1/')
      fi

      if [ ! -z "$rep" ]; then
        if [ -f $rep ]; then
          echo "$cm: $lib -> $rep"
          sed -e "s|\([\";]\)$lib\([\";]\)|\1$rep\2|g" -i $cm
        else
          echo "$cm: $lib is specified, but $rep doesn't exist"
        fi
      fi
    done
  done

  echo "finished" >> $statuslog
}
